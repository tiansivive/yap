{"version":3,"sources":["../../src/modules/loading.ts"],"sourcesContent":["import * as EB from \"@yap/elaboration\";\nimport * as NF from \"@yap/elaboration/normalization\";\nimport * as Src from \"@yap/src/index\";\n\nimport * as V2 from \"@yap/elaboration/shared/monad.v2\";\n\nimport * as Sub from \"@yap/elaboration/unification/substitution\";\n\nimport { Either } from \"fp-ts/lib/Either\";\nimport { Option } from \"fp-ts/lib/Option\";\nimport * as O from \"fp-ts/lib/Option\";\nimport * as R from \"fp-ts/lib/Record\";\nimport * as E from \"fp-ts/lib/Either\";\nimport * as F from \"fp-ts/lib/function\";\n\nimport fs from \"fs\";\nimport { resolve } from \"path\";\nimport Nearley from \"nearley\";\nimport Grammar from \"@yap/src/grammar\";\nimport * as A from \"fp-ts/lib/Array\";\n\nimport * as P from \"@yap/elaboration/shared/provenance\";\n\nimport { set, setProp, update } from \"@yap/utils\";\nimport { GlobalDefaults } from \"../compile\";\nimport { defaultContext } from \"@yap/shared/lib/constants\";\n\ntype ModuleName = string;\nexport const globalModules: Record<ModuleName, Interface> = {};\n\nexport type Interface = {\n\timports: Record<string, Separated>;\n\texports: string[];\n\n\tforeign: [string, Either<V2.Err, EB.AST>][];\n\tletdecs: [string, Either<V2.Err, EB.AST>][];\n\terrors: V2.Err[];\n};\n\ntype Separated = [Array<[string, V2.Err]>, Array<[string, EB.AST]>];\n\nexport const mkInterface = (moduleName: ModuleName, visited: string[] = [], opts = GlobalDefaults): Interface => {\n\tif (globalModules[moduleName]) {\n\t\treturn globalModules[moduleName];\n\t}\n\n\tif (visited.includes(moduleName)) {\n\t\tthrow new Error(\"Circular dependency detected: \" + visited.join(\" -> \") + \" -> \" + moduleName);\n\t}\n\n\tconst str = fs.readFileSync(resolve(process.cwd(), opts.baseUrl, moduleName), { encoding: \"utf-8\" });\n\tconst parser = new Nearley.Parser(Nearley.Grammar.fromCompiled(Grammar));\n\n\tconst data = parser.feed(str);\n\tif (data.results.length !== 1) {\n\t\tthrow new Error(\"Failed to parse module: \" + moduleName + \". Too many parse results: \" + data.results.length);\n\t}\n\tconst mod: Src.Module = data.results[0];\n\n\ttype Separated = [Array<[string, V2.Err]>, Array<[string, EB.AST]>];\n\tconst importsPerFile = mod.imports.reduce(\n\t\t(record, stmt) => {\n\t\t\tconst imports = F.pipe(\n\t\t\t\tresolveImports(stmt, mkInterface(stmt.filepath, [moduleName, ...visited])),\n\t\t\t\tA.reduce([[], []], (result: Separated, [k, either]) => {\n\t\t\t\t\treturn F.pipe(\n\t\t\t\t\t\teither,\n\t\t\t\t\t\tE.fold(\n\t\t\t\t\t\t\t(e): typeof result => [result[0].concat([[k, e]]), result[1]],\n\t\t\t\t\t\t\t(v): typeof result => [result[0], result[1].concat([[k, v]])],\n\t\t\t\t\t\t),\n\t\t\t\t\t);\n\t\t\t\t}),\n\t\t\t);\n\n\t\t\treturn set(record, stmt.filepath.replace(\".yap\", \"\"), imports);\n\t\t},\n\t\t{} as Record<string, Separated>,\n\t);\n\n\tconst allImports = Object.values(importsPerFile).flatMap(([errs, defs]) => defs);\n\tconst localModuleCtx: EB.Context = update(defaultContext, \"imports\", imports => ({ ...imports, ...R.fromEntries(allImports) }));\n\n\tconst iface: Interface = F.pipe(EB.Mod.elaborate(mod, localModuleCtx), setProp(\"imports\", importsPerFile));\n\tiface.errors.forEach(err => {\n\t\tV2.display(err);\n\t\tconsole.error(P.display(err.provenance || [], { cap: 100 }, Sub.empty, {}));\n\t});\n\n\tiface.letdecs.forEach(([name, result]) => {\n\t\tif (E.isLeft(result)) {\n\t\t\tconsole.warn(`Error in module ${moduleName} for let ${name}: ${result.left}`);\n\t\t\tV2.display(result.left);\n\t\t\tconsole.error(P.display(result.left.provenance || [], { cap: 100 }, Sub.empty, {}));\n\t\t}\n\t});\n\n\tglobalModules[moduleName] = iface;\n\treturn iface;\n};\n\nconst resolveImports = (stmt: Src.Import, imported: Interface): [string, Either<EB.V2.Err, EB.AST>][] => {\n\tconst defs = imported.letdecs.concat(imported.foreign);\n\n\tconst publicVars = defs.filter(([id]) => imported.exports.includes(id));\n\tif (stmt.type === \"*\") {\n\t\treturn publicVars.filter(([id]) => !stmt.hiding.includes(id));\n\t}\n\n\tif (stmt.type === \"explicit\") {\n\t\treturn publicVars.filter(([id]) => stmt.names.includes(id));\n\t}\n\n\tif (stmt.type === \"qualified\") {\n\t\treturn publicVars.filter(([id]) => !stmt.hiding.includes(id)).map(([id, ast]) => [`$${stmt.as}_${id}`, ast]);\n\t}\n\n\treturn publicVars;\n};\n"],"mappings":"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","names":[]}