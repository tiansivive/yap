{"version":3,"sources":["../../../src/elaboration/normalization/generalization.ts"],"sourcesContent":["import * as NF from \"@yap/elaboration/normalization\";\nimport { match } from \"ts-pattern\";\n\nimport * as EB from \"@yap/elaboration\";\nimport * as R from \"@yap/shared/rows\";\n\nimport * as Q from \"@yap/shared/modalities/multiplicity\";\n\nimport fp from \"lodash/fp\";\nimport * as F from \"fp-ts/function\";\nimport * as A from \"fp-ts/Array\";\nimport { set, update } from \"@yap/utils\";\nimport { Subst } from \"../unification/substitution\";\nimport { Liquid } from \"@yap/verification/modalities\";\nimport { collectMetasNF } from \"../shared/metas\";\n\ntype Meta = Extract<NF.Variable, { type: \"Meta\" }>;\n\n/**\n * Generalizes a value by replacing meta variables with bound variables, which are introduced by wrapping the value in a Pi type for each meta variable.\n */\nexport const generalize = (val: NF.Value, ctx: EB.Context): [NF.Value, EB.Context] => {\n\tconst ms = collectMetasNF(val, ctx.zonker);\n\n\tif (ms.length === 0) {\n\t\treturn [val, ctx];\n\t}\n\n\tconst charCode = \"a\".charCodeAt(0);\n\n\t// Build a single closure context that has all generalized metas mapped to the corresponding bound variables.\n\t// We also pre-extend names/types/env so quoting inside closures sees the right level indices.\n\tconst extendedCtx = ms.reduce((acc, m, i) => {\n\t\tconst name = `${String.fromCharCode(charCode + i)}`;\n\t\tconst boundLvl = i; // outermost binder is level 0 when quoting with lvl = ms.length\n\t\tconst { ann } = ctx.metas[m.val];\n\t\tconst withBinder = EB.bind(acc, { type: \"Pi\", variable: name }, ann, \"inserted\");\n\t\treturn set(withBinder, [\"zonker\", `${m.val}`] as const, NF.Constructors.Var({ type: \"Bound\", lvl: boundLvl }));\n\t}, ctx);\n\n\t// Wrap from inner to outer. Each Pi body is quoted with lvl equal to the number of binders in scope.\n\tconst generalized = A.reverse(ms).reduce<NF.Value>((body, m, i) => {\n\t\tconst idx = ms.length - 1 - i; // the idx is the complement of i, since we're going from inner to outer\n\t\tconst variable = String.fromCharCode(charCode + idx);\n\t\t// Quote with all binders in scope: lvl = ms.length - i\n\t\tconst term = NF.quote(extendedCtx, ms.length - i, body);\n\t\tconst { ann } = ctx.metas[m.val];\n\t\treturn NF.Constructors.Pi(variable, \"Implicit\", ann, NF.Constructors.Closure(extendedCtx, term));\n\t}, val);\n\n\t// Return the extended ctx so callers can keep the zonker mapping for subsequent passes (instantiate, etc.)\n\treturn [generalized, extendedCtx];\n};\n\n/**\n * Instantiates unconstrained meta variables in a Normal Form (NF) to default values based on their annotations.\n * Constrained metas (those that have been unified to some value) are left alone.\n */\nexport const instantiate = (nf: NF.Value, ctx: EB.Context): NF.Value => {\n\treturn match(nf)\n\t\t.with({ type: \"Var\" }, v => {\n\t\t\tif (v.variable.type !== \"Meta\") {\n\t\t\t\treturn v;\n\t\t\t}\n\n\t\t\tif (!!ctx.zonker[v.variable.val]) {\n\t\t\t\t// Solved meta means it's in the zonker = not unconstrained, so no need to instantiate it\n\t\t\t\treturn v;\n\t\t\t}\n\t\t\tconst { ann } = ctx.metas[v.variable.val];\n\t\t\treturn match(ann)\n\t\t\t\t.with({ type: \"Lit\", value: { type: \"Atom\", value: \"Row\" } }, () => NF.Constructors.Row({ type: \"empty\" }))\n\t\t\t\t.with({ type: \"Lit\", value: { type: \"Atom\", value: \"Type\" } }, () => NF.Constructors.Lit({ type: \"Atom\", value: \"Any\" }))\n\t\t\t\t.otherwise(() => NF.Constructors.Var(v.variable));\n\t\t})\n\t\t.with({ type: \"Lit\" }, lit => lit)\n\t\t.with(NF.Patterns.Lambda, ({ binder, closure }) => {\n\t\t\tconst ann = instantiate(binder.annotation, ctx);\n\t\t\tconst xtended = EB.bind(closure.ctx, binder, ann);\n\t\t\treturn NF.Constructors.Lambda(\n\t\t\t\tbinder.variable,\n\t\t\t\tbinder.icit,\n\t\t\t\tupdate(closure, \"term\", t => EB.Icit.instantiate(t, xtended)),\n\t\t\t\tann,\n\t\t\t);\n\t\t})\n\t\t.with(NF.Patterns.Pi, ({ binder, closure }) => {\n\t\t\tconst ann = instantiate(binder.annotation, ctx);\n\t\t\tconst xtended = EB.bind(closure.ctx, binder, ann);\n\t\t\treturn NF.Constructors.Pi(\n\t\t\t\tbinder.variable,\n\t\t\t\tbinder.icit,\n\t\t\t\tann,\n\t\t\t\tupdate(closure, \"term\", t => EB.Icit.instantiate(t, xtended)),\n\t\t\t);\n\t\t})\n\t\t.with(NF.Patterns.Mu, ({ binder, closure }) => {\n\t\t\tconst ann = instantiate(binder.annotation, ctx);\n\t\t\tconst xtended = EB.bind(closure.ctx, binder, ann);\n\t\t\treturn NF.Constructors.Mu(\n\t\t\t\tbinder.variable,\n\t\t\t\tbinder.source,\n\t\t\t\tann,\n\t\t\t\tupdate(closure, \"term\", t => EB.Icit.instantiate(t, xtended)),\n\t\t\t);\n\t\t})\n\t\t.with({ type: \"App\" }, ({ icit, func, arg }) => NF.Constructors.App(instantiate(func, ctx), instantiate(arg, ctx), icit))\n\t\t.with({ type: \"Row\" }, ({ row }) =>\n\t\t\tNF.Constructors.Row(\n\t\t\t\tR.traverse(\n\t\t\t\t\trow,\n\t\t\t\t\tv => instantiate(v, ctx),\n\t\t\t\t\tv => R.Constructors.Variable(v),\n\t\t\t\t),\n\t\t\t),\n\t\t)\n\t\t.with({ type: \"Neutral\" }, ({ value }) => NF.Constructors.Neutral(instantiate(value, ctx)))\n\t\t.with(NF.Patterns.Modal, ({ value, modalities }) =>\n\t\t\tNF.Constructors.Modal(instantiate(value, ctx), {\n\t\t\t\tquantity: modalities.quantity,\n\t\t\t\tliquid: instantiate(modalities.liquid, ctx),\n\t\t\t}),\n\t\t)\n\t\t.otherwise(() => {\n\t\t\tthrow new Error(\"Traverse: Not implemented yet\");\n\t\t});\n};\n"],"mappings":"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","names":[]}