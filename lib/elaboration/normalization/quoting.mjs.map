{"version":3,"sources":["../../../src/elaboration/normalization/quoting.ts"],"sourcesContent":["import * as EB from \"@yap/elaboration\";\n\nimport * as NF from \".\";\nimport { match } from \"ts-pattern\";\n\n/**\n * Quotes a value in the given context and level.\n * We explicitly pass the level to avoid extending the context when quoting under binders.\n */\nexport const quote = (ctx: EB.Context, lvl: number, val: NF.Value): EB.Term => {\n\treturn match(val)\n\t\t.with({ type: \"Lit\" }, ({ value }) => EB.Constructors.Lit(value))\n\t\t.with({ type: \"Var\" }, ({ variable }) =>\n\t\t\tmatch(variable)\n\t\t\t\t.with({ type: \"Bound\" }, v => {\n\t\t\t\t\treturn EB.Constructors.Var({ type: \"Bound\", index: lvl - v.lvl - 1 });\n\t\t\t\t})\n\t\t\t\t// .with({ type: \"Meta\" }, v => {\n\t\t\t\t// \tconst zonked = ctx.zonker[v.val];\n\t\t\t\t// \tif (zonked) {\n\t\t\t\t// \t\treturn quote(ctx, lvl, zonked);\n\t\t\t\t// \t}\n\t\t\t\t// \treturn EB.Constructors.Var(v);\n\t\t\t\t// })\n\t\t\t\t.otherwise(v => EB.Constructors.Var(v)),\n\t\t)\n\n\t\t.with({ type: \"Neutral\" }, ({ value }) => quote(ctx, lvl, value))\n\n\t\t.with({ type: \"App\" }, ({ func, arg, icit }) => EB.Constructors.App(icit, quote(ctx, lvl, func), quote(ctx, lvl, arg)))\n\t\t.with({ type: \"Abs\", binder: { type: \"Lambda\" } }, ({ binder, closure }) => {\n\t\t\tconst { variable, icit, annotation } = binder;\n\t\t\tconst val = NF.apply(binder, closure, NF.Constructors.Rigid(lvl));\n\t\t\tconst body = quote(ctx, lvl + 1, val);\n\t\t\tconst ann = NF.quote(ctx, lvl, annotation);\n\t\t\treturn EB.Constructors.Lambda(variable, icit, body, ann);\n\t\t})\n\t\t.with({ type: \"Abs\", binder: { type: \"Pi\" } }, ({ binder, closure }) => {\n\t\t\tconst { variable, icit, annotation } = binder;\n\t\t\tconst val = NF.apply(binder, closure, NF.Constructors.Rigid(lvl));\n\t\t\tconst body = quote(ctx, lvl + 1, val);\n\t\t\tconst ann = NF.quote(ctx, lvl, annotation);\n\t\t\treturn EB.Constructors.Pi(variable, icit, ann, body);\n\t\t})\n\t\t.with({ type: \"Abs\", binder: { type: \"Mu\" } }, ({ binder, closure }) => {\n\t\t\tconst { variable, source, annotation } = binder;\n\t\t\tconst val = NF.apply(binder, closure, NF.Constructors.Rigid(lvl));\n\t\t\tconst body = quote(ctx, lvl + 1, val);\n\t\t\tconst ann = NF.quote(ctx, lvl, annotation);\n\t\t\treturn EB.Constructors.Mu(variable, source, ann, body);\n\t\t})\n\t\t.with({ type: \"Row\" }, ({ row }) => {\n\t\t\tconst _quote = (r: NF.Row): EB.Row =>\n\t\t\t\tmatch(r)\n\t\t\t\t\t.with({ type: \"empty\" }, (): EB.Row => ({ type: \"empty\" }))\n\t\t\t\t\t.with({ type: \"extension\" }, ({ label, value, row }) => EB.Constructors.Extension(label, quote(ctx, lvl, value), _quote(row)))\n\t\t\t\t\t.with({ type: \"variable\" }, ({ variable }): EB.Row => {\n\t\t\t\t\t\tconst v = match(variable)\n\t\t\t\t\t\t\t.with({ type: \"Bound\" }, (v): EB.Variable => ({ type: \"Bound\", index: lvl - v.lvl - 1 }))\n\t\t\t\t\t\t\t.otherwise(v => v);\n\t\t\t\t\t\treturn { type: \"variable\", variable: v };\n\t\t\t\t\t})\n\t\t\t\t\t.exhaustive();\n\n\t\t\treturn EB.Constructors.Row(_quote(row));\n\t\t})\n\t\t.with({ type: \"External\" }, ({ name, arity, compute, args }) => {\n\t\t\treturn args.reduce((acc, arg) => EB.Constructors.App(\"Explicit\", acc, quote(ctx, lvl, arg)), EB.Constructors.Var({ type: \"Foreign\", name }));\n\t\t})\n\t\t.with({ type: \"Modal\" }, ({ value, modalities }) =>\n\t\t\tEB.Constructors.Modal(quote(ctx, lvl, value), {\n\t\t\t\tquantity: modalities.quantity,\n\t\t\t\tliquid: quote(ctx, lvl, modalities.liquid),\n\t\t\t}),\n\t\t)\n\t\t.otherwise(nf => {\n\t\t\tthrow new Error(\"Quote: Not implemented yet: \" + NF.display(nf, ctx));\n\t\t});\n};\n\nexport const closeVal = (ctx: EB.Context, value: NF.Value): NF.Closure => ({\n\ttype: \"Closure\",\n\tctx,\n\tterm: NF.quote(ctx, ctx.env.length + 1, value),\n});\n"],"mappings":"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","names":["val","row","v"]}