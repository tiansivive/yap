{"version":3,"sources":["../../../../src/elaboration/normalization/syntax/term.ts"],"sourcesContent":["import * as R from \"@yap/shared/rows\";\nimport * as EB from \"@yap/elaboration\";\n\nimport * as Lit from \"@yap/shared/literals\";\nimport { Literal } from \"@yap/shared/literals\";\nimport { Implicitness } from \"@yap/shared/implicitness\";\nimport { match } from \"ts-pattern\";\nimport { Types, update } from \"@yap/utils\";\n\nimport * as Modal from \"@yap/verification/modalities/shared\";\nimport { SetFieldType } from \"type-fest\";\n\nexport const nf_tag: unique symbol = Symbol(\"NF\");\n\nexport type Value = Types.Brand<typeof nf_tag, Constructor> & { id: number };\ntype Constructor =\n\t| { type: \"Var\"; variable: Variable }\n\t| { type: \"Lit\"; value: Literal }\n\t| { type: \"App\"; func: Value; arg: Value; icit: Implicitness }\n\t| { type: \"Row\"; row: Row }\n\t| { type: \"Abs\"; binder: Binder; closure: Closure }\n\t| { type: \"Neutral\"; value: Value }\n\t| { type: \"Modal\"; value: Value; modalities: Modalities }\n\t| { type: \"External\"; name: string; arity: number; compute: (...args: Value[]) => Value; args: Value[] };\n\nexport type Row = R.Row<Value, Variable>;\n\nexport type Binder =\n\t| { type: \"Pi\"; variable: string; annotation: Value; icit: Implicitness }\n\t| { type: \"Lambda\"; variable: string; annotation: Value; icit: Implicitness }\n\t| { type: \"Mu\"; variable: string; annotation: Value; source: string };\n\nexport type Variable =\n\t| { type: \"Bound\"; lvl: number }\n\t| { type: \"Free\"; name: string }\n\t| { type: \"Label\"; name: string }\n\t| { type: \"Foreign\"; name: string }\n\t/**\n\t * @see Unification.bind for the reason why we need to store the level\n\t */\n\t| { type: \"Meta\"; val: number; lvl: number };\n\nexport type Closure =\n\t| { type: \"Closure\"; ctx: EB.Context; term: EB.Term }\n\t| { type: \"PrimOp\"; ctx: EB.Context; term: EB.Term; arity: number; compute: (...args: Value[]) => Value };\n\nexport type Modalities = SetFieldType<Modal.Annotations, \"liquid\", Value>;\n\nlet currentId = 0;\nconst nextId = () => ++currentId;\nexport const mk = (val: Constructor): Value => {\n\treturn { ...Types.make(nf_tag, val), id: nextId() };\n};\n\nexport const Constructors = {\n\tVar: (variable: Variable): Value => mk({ type: \"Var\", variable }),\n\tPi: (variable: string, icit: Implicitness, annotation: Value, closure: Closure) =>\n\t\tmk({\n\t\t\ttype: \"Abs\" as const,\n\t\t\tbinder: { type: \"Pi\" as const, variable, icit, annotation },\n\t\t\tclosure,\n\t\t}) as Value & { type: \"Abs\"; binder: { type: \"Pi\" } },\n\tMu: (variable: string, source: string, annotation: Value, closure: Closure): Value =>\n\t\tmk({\n\t\t\ttype: \"Abs\" as const,\n\t\t\tbinder: { type: \"Mu\", variable, annotation, source },\n\t\t\tclosure,\n\t\t}),\n\tLambda: (variable: string, icit: Implicitness, closure: Closure, annotation: Value): Value =>\n\t\tmk({\n\t\t\ttype: \"Abs\" as const,\n\t\t\tbinder: { type: \"Lambda\" as const, variable, icit, annotation },\n\t\t\tclosure,\n\t\t}),\n\tRigid: (lvl: number): Value =>\n\t\tmk({\n\t\t\ttype: \"Neutral\",\n\t\t\tvalue: Constructors.Var({ type: \"Bound\", lvl }),\n\t\t}),\n\tFlex: (variable: Extract<Variable, { type: \"Meta\" }>): Value =>\n\t\tmk({\n\t\t\ttype: \"Neutral\",\n\t\t\tvalue: Constructors.Var(variable),\n\t\t}),\n\tLit: (value: Literal) =>\n\t\tmk({\n\t\t\ttype: \"Lit\" as const,\n\t\t\tvalue,\n\t\t}),\n\tAtom: (value: string) => mk(Constructors.Lit(Lit.Atom(value))),\n\tNeutral: (value: Value) =>\n\t\tmk({\n\t\t\ttype: \"Neutral\" as const,\n\t\t\tvalue,\n\t\t}),\n\tApp: (func: Value, arg: Value, icit: Implicitness) =>\n\t\tmk({\n\t\t\ttype: \"App\" as const,\n\t\t\tfunc,\n\t\t\targ,\n\t\t\ticit,\n\t\t}),\n\tClosure: (ctx: EB.Context, term: EB.Term): Closure => ({ type: \"Closure\", ctx, term }),\n\tPrimop: (ctx: EB.Context, term: EB.Term, arity: number, compute: (...args: Value[]) => Value): Closure => ({ type: \"PrimOp\", ctx, term, arity, compute }),\n\n\tRow: (row: Row): Value => mk({ type: \"Row\", row }),\n\tExtension: (label: string, value: Value, row: Row): Row => ({ type: \"extension\", label, value, row }),\n\n\tSchema: (row: Row): Value => Constructors.Neutral(Constructors.App(Constructors.Lit(Lit.Atom(\"Schema\")), Constructors.Row(row), \"Explicit\")),\n\tVariant: (row: Row): Value => Constructors.Neutral(Constructors.App(Constructors.Lit(Lit.Atom(\"Variant\")), Constructors.Row(row), \"Explicit\")),\n\n\tModal: (value: Value, modalities: Modalities): Value =>\n\t\tmk({\n\t\t\ttype: \"Modal\",\n\t\t\tvalue,\n\t\t\tmodalities,\n\t\t}),\n\tExternal: (name: string, arity: number, compute: (...args: Value[]) => Value, args: Value[]): Value => mk({ type: \"External\", name, arity, compute, args }),\n};\n\nexport const Type: Value = mk({\n\ttype: \"Lit\",\n\tvalue: { type: \"Atom\", value: \"Type\" },\n});\n\nexport const Row: Value = mk({\n\ttype: \"Lit\",\n\tvalue: { type: \"Atom\", value: \"Row\" },\n});\n\nexport const Indexed: Value = mk({\n\ttype: \"Var\",\n\tvariable: { type: \"Foreign\", name: \"Indexed\" },\n});\n\nexport const Any = mk({\n\ttype: \"Lit\",\n\tvalue: { type: \"Atom\", value: \"Any\" },\n});\n\nexport const Patterns = {\n\tVar: { type: \"Var\" } as const,\n\tRigid: { type: \"Var\", variable: { type: \"Bound\" } } as const,\n\tFlex: { type: \"Var\", variable: { type: \"Meta\" } } as const,\n\tFree: { type: \"Var\", variable: { type: \"Free\" } } as const,\n\tLabel: { type: \"Var\", variable: { type: \"Label\" } } as const,\n\n\tLit: { type: \"Lit\" } as const,\n\tAtom: { type: \"Lit\", value: { type: \"Atom\" } } as const,\n\tType: { type: \"Lit\", value: { type: \"Atom\", value: \"Type\" } } as const,\n\tUnit: { type: \"Lit\", value: { type: \"Atom\", value: \"Unit\" } } as const,\n\n\tVariant: { type: \"App\", func: { type: \"Lit\", value: { type: \"Atom\", value: \"Variant\" } }, arg: { type: \"Row\" } } as const,\n\tSchema: { type: \"App\", func: { type: \"Lit\", value: { type: \"Atom\", value: \"Schema\" } }, arg: { type: \"Row\" } } as const,\n\tStruct: { type: \"App\", func: { type: \"Lit\", value: { type: \"Atom\", value: \"Struct\" } }, arg: { type: \"Row\" } } as const,\n\n\tApp: { type: \"App\" } as const,\n\tPi: { type: \"Abs\", binder: { type: \"Pi\" } } as const,\n\tLambda: { type: \"Abs\", binder: { type: \"Lambda\" } } as const,\n\tMu: { type: \"Abs\", binder: { type: \"Mu\" } } as const,\n\tRow: { type: \"Row\" } as const,\n\tModal: { type: \"Modal\" } as const,\n\n\tRecursive: {\n\t\ttype: \"App\",\n\t\tfunc: {\n\t\t\ttype: \"Abs\",\n\t\t\tbinder: { type: \"Mu\" },\n\t\t},\n\t} as const,\n\n\tIndexed: {\n\t\ttype: \"App\",\n\t\ticit: \"Implicit\",\n\t\tfunc: {\n\t\t\ttype: \"App\",\n\t\t\tfunc: {\n\t\t\t\ttype: \"App\",\n\t\t\t\tfunc: {\n\t\t\t\t\ttype: \"Var\",\n\t\t\t\t\tvariable: { type: \"Foreign\", name: \"Indexed\" },\n\t\t\t\t},\n\t\t\t},\n\t\t},\n\t} as const,\n\n\tHashMap: {\n\t\ttype: \"Neutral\",\n\t\tvalue: {\n\t\t\ttype: \"App\",\n\t\t\ticit: \"Implicit\",\n\t\t\tfunc: {\n\t\t\t\ttype: \"App\",\n\t\t\t\tfunc: {\n\t\t\t\t\ttype: \"App\",\n\t\t\t\t\tfunc: {\n\t\t\t\t\t\ttype: \"Var\",\n\t\t\t\t\t\tvariable: { type: \"Foreign\", name: \"Indexed\" },\n\t\t\t\t\t},\n\t\t\t\t\targ: { type: \"Lit\", value: { type: \"Atom\", value: \"String\" } },\n\t\t\t\t},\n\t\t\t},\n\t\t},\n\t} as const,\n\tArray: {\n\t\ttype: \"App\",\n\t\tfunc: {\n\t\t\ttype: \"App\",\n\t\t\tfunc: { type: \"Lit\", value: { type: \"Atom\", value: \"Indexed\" } },\n\t\t\targ: { type: \"Lit\", value: { type: \"Atom\", value: \"Num\" } },\n\t\t},\n\t} as const,\n};\n"],"mappings":"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","names":[]}