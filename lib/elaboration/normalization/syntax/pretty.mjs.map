{"version":3,"sources":["../../../../src/elaboration/normalization/syntax/pretty.ts"],"sourcesContent":["import { match } from \"ts-pattern\";\nimport * as NF from \"../index\";\n\nimport * as Lit from \"@yap/shared/literals\";\nimport * as Icit from \"@yap/shared/implicitness\";\nimport * as Q from \"@yap/shared/modalities/multiplicity\";\nimport * as R from \"@yap/shared/rows\";\n\nimport * as EB from \"@yap/elaboration\";\nimport { options } from \"@yap/shared/config/options\";\nimport { compose } from \"../../unification\";\n\n// TODO:  add environment to properly display variables\nexport const display = (value: NF.Value, ctx: Pick<EB.Context, \"zonker\" | \"metas\" | \"env\">, opts = { deBruijn: false }): string => {\n\treturn match(value as NF.Value)\n\t\t.with({ type: \"Lit\" }, ({ value }) => Lit.display(value))\n\t\t.with({ type: \"Var\" }, ({ variable }) =>\n\t\t\tmatch(variable)\n\t\t\t\t.with({ type: \"Bound\" }, ({ lvl }) => {\n\t\t\t\t\tconst name = ctx.env[ctx.env.length - 1 - lvl]?.name.variable ?? `L${lvl}`;\n\t\t\t\t\treturn name + (opts.deBruijn ? `#L${lvl}` : \"\");\n\t\t\t\t})\n\t\t\t\t.with({ type: \"Free\" }, ({ name }) => name)\n\t\t\t\t.with({ type: \"Label\" }, ({ name }) => `:${name}`)\n\t\t\t\t.with({ type: \"Foreign\" }, ({ name }) => `FFI.${name}`)\n\t\t\t\t.with({ type: \"Meta\" }, ({ val }) => {\n\t\t\t\t\tconst m = ctx.zonker[val] ? display(ctx.zonker[val], ctx, opts) : `?${val}`;\n\t\t\t\t\treturn m; //options.verbose ? `(${m} :: ${display(ann, zonker)})` : m;\n\t\t\t\t})\n\t\t\t\t.exhaustive(),\n\t\t)\n\t\t.with({ type: \"Neutral\" }, ({ value }) => display(value, ctx, opts))\n\n\t\t.with({ type: \"Abs\", binder: { type: \"Mu\" } }, ({ binder }) => binder.source)\n\t\t.with({ type: \"Abs\" }, ({ binder, closure }) => {\n\t\t\tconst b = match(binder)\n\t\t\t\t.with({ type: \"Lambda\" }, ({ variable }) => `λ${variable}`)\n\t\t\t\t.with({ type: \"Pi\" }, ({ variable, annotation }) => `Π(${variable}: ${display(annotation, ctx, opts)})`)\n\t\t\t\t.with({ type: \"Mu\" }, ({ variable, annotation }) => `μ(${variable}: ${display(annotation, ctx, opts)})`)\n\t\t\t\t.exhaustive();\n\n\t\t\tconst arr = binder.type !== \"Mu\" && binder.icit === \"Implicit\" ? \"=>\" : \"->\";\n\n\t\t\tconst z = compose(ctx.zonker, closure.ctx.zonker);\n\n\t\t\tconst extended = { ...closure.ctx, metas: ctx.metas, zonker: z, env: [{ name: { variable: binder.variable } }, ...closure.ctx.env] } as Pick<\n\t\t\t\tEB.Context,\n\t\t\t\t\"env\" | \"zonker\" | \"metas\"\n\t\t\t>;\n\t\t\tconst printedEnv = extended.env\n\t\t\t\t.map(({ nf, name }) => {\n\t\t\t\t\tif (nf) {\n\t\t\t\t\t\treturn `${name.variable} = ${NF.display(nf, extended, opts)}`;\n\t\t\t\t\t}\n\t\t\t\t\treturn name.variable;\n\t\t\t\t})\n\t\t\t\t.slice(1); // remove the bound variable itself\n\n\t\t\tlet prettyEnv = printedEnv.length > 0 ? `Γ: ${printedEnv.join(\"; \")}` : \"·\";\n\n\t\t\treturn `${b} ${arr} (closure: ${EB.Display.Term(closure.term, extended, opts)} -| ${prettyEnv})`;\n\t\t})\n\t\t.with({ type: \"App\" }, ({ func, arg, icit }) => {\n\t\t\tconst f = display(func, ctx, opts);\n\t\t\tconst a = display(arg, ctx, opts);\n\n\t\t\tconst wrappedFn = func.type !== \"Var\" && func.type !== \"Lit\" && func.type !== \"App\" ? `(${f})` : f;\n\t\t\tconst wrappedArg = arg.type === \"Abs\" || arg.type === \"App\" ? `(${a})` : a;\n\n\t\t\treturn `${wrappedFn} ${Icit.display(icit)}${wrappedArg}`;\n\t\t})\n\t\t.with({ type: \"Row\" }, ({ row }) =>\n\t\t\tR.display({\n\t\t\t\tterm: (term: NF.Value | NF.Value) => display(term, ctx, opts),\n\t\t\t\tvar: (v: NF.Variable) => display(NF.mk({ type: \"Var\", variable: v }), ctx, opts),\n\t\t\t})(row),\n\t\t)\n\t\t.with({ type: \"Modal\" }, ({ modalities, value }) => {\n\t\t\treturn `<${Q.display(modalities.quantity)}> ${display(value, ctx, opts)} [| ${display(modalities.liquid, ctx, opts)} |]`;\n\t\t})\n\t\t.with({ type: \"External\" }, external => {\n\t\t\tconst args = external.args.map(arg => `(${display(arg, ctx, opts)})`).join(\" \");\n\t\t\treturn `(${external.name}: ${args})`;\n\t\t})\n\n\t\t.exhaustive();\n\t//.exhaustive();\n};\n"],"mappings":"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","names":["value"]}