{"version":3,"sources":["../../../src/elaboration/shared/metas.ts"],"sourcesContent":["import * as NF from \"@yap/elaboration/normalization\";\nimport { match } from \"ts-pattern\";\n\nimport * as EB from \"@yap/elaboration\";\nimport * as R from \"@yap/shared/rows\";\n\nimport fp from \"lodash/fp\";\nimport * as F from \"fp-ts/function\";\n\nimport { Subst } from \"../unification/substitution\";\n\ntype MetaNF = Extract<NF.Variable, { type: \"Meta\" }>;\n\nexport const collectMetasNF = (val: NF.Value, zonker: Subst): MetaNF[] => {\n\tconst ms = match(val)\n\t\t.with(NF.Patterns.Lit, () => [])\n\t\t.with(NF.Patterns.Flex, ({ variable }) => {\n\t\t\tif (!zonker[variable.val]) {\n\t\t\t\treturn [variable];\n\t\t\t}\n\t\t\treturn collectMetasNF(zonker[variable.val], zonker);\n\t\t})\n\t\t.with(NF.Patterns.Var, () => [])\n\t\t.with(NF.Patterns.App, ({ func, arg }) => [...collectMetasNF(func, zonker), ...collectMetasNF(arg, zonker)])\n\t\t.with(NF.Patterns.Row, ({ row }) =>\n\t\t\tR.fold(\n\t\t\t\trow,\n\t\t\t\t(val, l, ms) => ms.concat(collectMetasNF(val, zonker)),\n\t\t\t\t(v, ms) => {\n\t\t\t\t\tif (v.type !== \"Meta\") {\n\t\t\t\t\t\treturn ms;\n\t\t\t\t\t}\n\n\t\t\t\t\tif (!zonker[v.val]) {\n\t\t\t\t\t\treturn [v, ...ms];\n\t\t\t\t\t}\n\n\t\t\t\t\treturn collectMetasNF(zonker[v.val], zonker);\n\t\t\t\t},\n\t\t\t\t[] as MetaNF[],\n\t\t\t),\n\t\t)\n\t\t.with({ type: \"Neutral\" }, ({ value }) => collectMetasNF(value, zonker))\n\t\t.with(NF.Patterns.Lambda, ({ closure }) => collectMetasEB(closure.term, zonker))\n\t\t.with(NF.Patterns.Pi, ({ closure, binder }) => [...collectMetasNF(binder.annotation, zonker), ...collectMetasEB(closure.term, zonker)])\n\t\t.with(NF.Patterns.Mu, ({ closure, binder }) => [...collectMetasNF(binder.annotation, zonker), ...collectMetasEB(closure.term, zonker)])\n\t\t.with(NF.Patterns.Modal, ({ value }) => collectMetasNF(value, zonker))\n\t\t.otherwise(() => {\n\t\t\tthrow new Error(\"metas: Not implemented yet\");\n\t\t});\n\n\treturn F.pipe(\n\t\tms,\n\t\tfp.uniqBy(m => m.val),\n\t);\n};\n\ntype MetaEB = Extract<EB.Variable, { type: \"Meta\" }>;\nexport const collectMetasEB = (tm: EB.Term, zonker: Subst): MetaEB[] => {\n\tconst _metas = (tm: EB.Term): MetaEB[] => {\n\t\tconst ms = match(tm)\n\t\t\t.with({ type: \"Var\" }, ({ variable }) => {\n\t\t\t\tif (variable.type !== \"Meta\") {\n\t\t\t\t\treturn [];\n\t\t\t\t}\n\n\t\t\t\tif (!zonker[variable.val]) {\n\t\t\t\t\treturn [variable];\n\t\t\t\t}\n\n\t\t\t\treturn collectMetasNF(zonker[variable.val], zonker);\n\t\t\t})\n\t\t\t.with({ type: \"Lit\" }, () => [])\n\t\t\t.with({ type: \"Abs\", binding: { type: \"Lambda\" } }, ({ body, binding }) => _metas(body))\n\t\t\t.with({ type: \"Abs\", binding: { type: \"Pi\" } }, ({ body, binding }) => [..._metas(binding.annotation), ..._metas(body)])\n\t\t\t.with({ type: \"Abs\", binding: { type: \"Mu\" } }, ({ body, binding }) => [..._metas(binding.annotation), ..._metas(body)])\n\t\t\t.with({ type: \"App\" }, ({ func, arg }) => [..._metas(func), ..._metas(arg)])\n\t\t\t.with({ type: \"Row\" }, ({ row }) =>\n\t\t\t\tR.fold(\n\t\t\t\t\trow,\n\t\t\t\t\t(val, l, ms) => ms.concat(_metas(val)),\n\t\t\t\t\t(v, ms) => (v.type === \"Meta\" ? [...ms, v] : ms),\n\t\t\t\t\t[] as MetaEB[],\n\t\t\t\t),\n\t\t\t)\n\t\t\t.with({ type: \"Proj\" }, ({ term }) => _metas(term))\n\t\t\t.with({ type: \"Inj\" }, ({ value, term }) => [..._metas(value), ..._metas(term)])\n\t\t\t//.with({ type: \"Annotation\" }, ({ term, ann }) => [..._metas(term), ..._metas(ann)])\n\t\t\t.with({ type: \"Match\" }, ({ scrutinee, alternatives }) => [..._metas(scrutinee), ...alternatives.flatMap(alt => _metas(alt.term))])\n\t\t\t.with({ type: \"Block\" }, ({ return: ret, statements }) => [..._metas(ret), ...statements.flatMap(s => _metas(s.value))])\n\t\t\t.with({ type: \"Modal\" }, ({ term }) => _metas(term))\n\t\t\t.otherwise(() => {\n\t\t\t\tthrow new Error(\"metas: Not implemented yet\");\n\t\t\t});\n\n\t\treturn ms;\n\t};\n\treturn _metas(tm);\n};\n\nexport const collect = {\n\tnf: collectMetasNF,\n\teb: collectMetasEB,\n};\n"],"mappings":"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","names":["val","ms","tm"]}