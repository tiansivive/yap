{"version":3,"sources":["../../../src/elaboration/inference/injection.ts"],"sourcesContent":["import * as EB from \"@yap/elaboration\";\nimport * as V2 from \"@yap/elaboration/shared/monad.v2\";\n\nimport * as NF from \"@yap/elaboration/normalization\";\nimport { match } from \"ts-pattern\";\n\nimport * as Lit from \"@yap/shared/literals\";\nimport * as Q from \"@yap/shared/modalities/multiplicity\";\n\nimport * as F from \"fp-ts/function\";\nimport { Liquid } from \"@yap/verification/modalities\";\n\ntype Injection = Extract<EB.Term, { type: \"injection\" }>;\n\nexport const infer = (injection: Injection): V2.Elaboration<EB.AST> =>\n\tV2.track(\n\t\t{ tag: \"src\", type: \"term\", term: injection, metadata: { action: \"infer\", description: \"Injection\" } },\n\t\tV2.Do<EB.AST, EB.AST>(function* () {\n\t\t\tconst { label, value, term } = injection;\n\t\t\tconst val = yield* EB.infer.gen(value);\n\t\t\tconst tm = yield* EB.infer.gen(term);\n\t\t\tconst injected = yield* inject.gen(label, val, tm);\n\t\t\treturn [EB.Constructors.Inj(label, val[0], tm[0]), injected, Q.add(tm[2], val[2])] satisfies EB.AST;\n\t\t}),\n\t);\ninfer.gen = F.flow(infer, V2.pure);\n\nconst inject = (label: string, value: EB.AST, tm: EB.AST): V2.Elaboration<NF.Value> =>\n\tV2.Do(function* () {\n\t\tconst ctx = yield* V2.ask();\n\t\tconst val = yield* V2.pure(\n\t\t\tmatch(tm[1])\n\t\t\t\t.with({ type: \"Neutral\" }, ({ value: v }) => inject(label, value, [tm[0], v, tm[2]]))\n\t\t\t\t.with({ type: \"Var\" }, _ =>\n\t\t\t\t\tV2.Do(function* () {\n\t\t\t\t\t\tconst r: NF.Row = { type: \"variable\", variable: yield* EB.freshMeta(ctx.env.length, NF.Row) };\n\t\t\t\t\t\tconst rowTypeCtor = EB.Constructors.Pi(\"rx\", \"Explicit\", EB.Constructors.Lit(Lit.Row()), EB.Constructors.Lit(Lit.Type()));\n\t\t\t\t\t\tconst ann = NF.evaluate(ctx, rowTypeCtor);\n\t\t\t\t\t\tconst ctor = NF.evaluate(ctx, EB.Constructors.Var(yield* EB.freshMeta(ctx.env.length, ann)));\n\n\t\t\t\t\t\tconst inferred = NF.Constructors.App(ctor, NF.Constructors.Row(r), \"Explicit\");\n\t\t\t\t\t\tconst extended = NF.Constructors.App(ctor, NF.Constructors.Row(NF.Constructors.Extension(label, value[1], r)), \"Explicit\");\n\n\t\t\t\t\t\tyield* V2.tell(\"constraint\", { type: \"assign\", left: inferred, right: tm[1], lvl: ctx.env.length });\n\t\t\t\t\t\treturn extended;\n\t\t\t\t\t}),\n\t\t\t\t)\n\t\t\t\t.with(\n\t\t\t\t\t{ type: \"App\", func: { type: \"Lit\", value: { type: \"Atom\" } }, arg: { type: \"Row\" } },\n\t\t\t\t\t({\n\t\t\t\t\t\tfunc: {\n\t\t\t\t\t\t\tvalue: { value },\n\t\t\t\t\t\t},\n\t\t\t\t\t}) => value === \"Schema\" || value === \"Variant\",\n\t\t\t\t\t({ func, arg }) => {\n\t\t\t\t\t\tconst extended = NF.Constructors.App(func, NF.Constructors.Row(NF.Constructors.Extension(label, value[1], arg.row)), \"Explicit\");\n\t\t\t\t\t\treturn V2.of(extended);\n\t\t\t\t\t},\n\t\t\t\t)\n\t\t\t\t.otherwise(_ => {\n\t\t\t\t\tthrow new Error(\"Injection: Expected Row type\");\n\t\t\t\t}),\n\t\t);\n\t\treturn val;\n\t});\n\ninject.gen = F.flow(inject, V2.pure);\n"],"mappings":"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","names":["value"]}