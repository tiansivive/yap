{"version":3,"sources":["../../../src/elaboration/inference/lambda.ts"],"sourcesContent":["import * as F from \"fp-ts/lib/function\";\n\nimport * as EB from \"@yap/elaboration\";\nimport * as V2 from \"@yap/elaboration/shared/monad.v2\";\nimport * as Q from \"@yap/shared/modalities/multiplicity\";\n\nimport * as NF from \"@yap/elaboration/normalization\";\nimport * as Src from \"@yap/src/index\";\n\nimport * as Log from \"@yap/shared/logging\";\n\nimport { Liquid } from \"@yap/verification/modalities\";\n\ntype Lambda = Extract<Src.Term, { type: \"lambda\" }>;\n\nexport const infer = (lam: Lambda): V2.Elaboration<EB.AST> =>\n\tV2.track(\n\t\t{ tag: \"src\", type: \"term\", term: lam, metadata: { action: \"infer\", description: \"Lambda\" } },\n\t\tV2.Do<EB.AST, EB.AST>(function* () {\n\t\t\tconst ctx = yield* V2.ask();\n\n\t\t\tconst [ann, us] = lam.annotation\n\t\t\t\t? yield* EB.check.gen(lam.annotation, NF.Type)\n\t\t\t\t: ([EB.Constructors.Var(yield* EB.freshMeta(ctx.env.length, NF.Type)), Q.noUsage(ctx.env.length)] as const);\n\n\t\t\tconst ty = NF.evaluate(ctx, ann);\n\n\t\t\tconst ast = yield* V2.local(\n\t\t\t\t_ctx => EB.bind(_ctx, { type: \"Lambda\", variable: lam.variable }, ty),\n\t\t\t\tV2.Do(function* () {\n\t\t\t\t\tconst inferred = yield* EB.infer.gen(lam.body);\n\t\t\t\t\tconst [bTerm, bType, [vu, ...bus]] = yield* EB.Icit.insert.gen(inferred);\n\t\t\t\t\t//yield* V2.tell(\"constraint\", { type: \"usage\", expected: mty[1], computed: vu });\n\n\t\t\t\t\tconst tm = EB.Constructors.Lambda(lam.variable, lam.icit, bTerm, ann);\n\t\t\t\t\tconst pi = NF.Constructors.Pi(lam.variable, lam.icit, ty, NF.closeVal(ctx, bType));\n\t\t\t\t\treturn [tm, pi, bus] satisfies EB.AST; // Remove the usage of the bound variable\n\t\t\t\t}),\n\t\t\t);\n\n\t\t\treturn ast as EB.AST; // Remove the usage of the bound variable\n\t\t}),\n\t);\n\ninfer.gen = F.flow(infer, V2.pure);\n"],"mappings":";AAAA,YAAY,OAAO;AAEnB,YAAY,QAAQ;AACpB,YAAY,QAAQ;AACpB,YAAY,OAAO;AAEnB,YAAY,QAAQ;AASb,MAAM,QAAQ,CAAC,QACrB,GAAG;AAAA,EACF,EAAE,KAAK,OAAO,MAAM,QAAQ,MAAM,KAAK,UAAU,EAAE,QAAQ,SAAS,aAAa,SAAS,EAAE;AAAA,EAC5F,GAAG,GAAmB,aAAa;AAClC,UAAM,MAAM,OAAO,GAAG,IAAI;AAE1B,UAAM,CAAC,KAAK,EAAE,IAAI,IAAI,aACnB,OAAO,GAAG,MAAM,IAAI,IAAI,YAAY,GAAG,IAAI,IAC1C,CAAC,GAAG,aAAa,IAAI,OAAO,GAAG,UAAU,IAAI,IAAI,QAAQ,GAAG,IAAI,CAAC,GAAG,EAAE,QAAQ,IAAI,IAAI,MAAM,CAAC;AAEjG,UAAM,KAAK,GAAG,SAAS,KAAK,GAAG;AAE/B,UAAM,MAAM,OAAO,GAAG;AAAA,MACrB,UAAQ,GAAG,KAAK,MAAM,EAAE,MAAM,UAAU,UAAU,IAAI,SAAS,GAAG,EAAE;AAAA,MACpE,GAAG,GAAG,aAAa;AAClB,cAAM,WAAW,OAAO,GAAG,MAAM,IAAI,IAAI,IAAI;AAC7C,cAAM,CAAC,OAAO,OAAO,CAAC,IAAI,GAAG,GAAG,CAAC,IAAI,OAAO,GAAG,KAAK,OAAO,IAAI,QAAQ;AAGvE,cAAM,KAAK,GAAG,aAAa,OAAO,IAAI,UAAU,IAAI,MAAM,OAAO,GAAG;AACpE,cAAM,KAAK,GAAG,aAAa,GAAG,IAAI,UAAU,IAAI,MAAM,IAAI,GAAG,SAAS,KAAK,KAAK,CAAC;AACjF,eAAO,CAAC,IAAI,IAAI,GAAG;AAAA,MACpB,CAAC;AAAA,IACF;AAEA,WAAO;AAAA,EACR,CAAC;AACF;AAED,MAAM,MAAM,EAAE,KAAK,OAAO,GAAG,IAAI;","names":[]}