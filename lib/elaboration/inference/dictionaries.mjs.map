{"version":3,"sources":["../../../src/elaboration/inference/dictionaries.ts"],"sourcesContent":["import * as F from \"fp-ts/lib/function\";\n\nimport * as EB from \"@yap/elaboration\";\nimport * as V2 from \"@yap/elaboration/shared/monad.v2\";\n\nimport * as NF from \"@yap/elaboration/normalization\";\nimport * as Src from \"@yap/src/index\";\n\nimport * as Q from \"@yap/shared/modalities/multiplicity\";\nimport { match } from \"ts-pattern\";\n\ntype Dictionary = Extract<Src.Term, { type: \"dict\" }>;\n\nexport const infer = (dict: Dictionary): V2.Elaboration<EB.AST> =>\n\tV2.track(\n\t\t{ tag: \"src\", type: \"term\", term: dict, metadata: { action: \"infer\", description: \"Dictionary\" } },\n\t\tV2.Do<EB.AST, EB.AST>(function* () {\n\t\t\tconst [tm1, ty1, us1] = yield EB.infer(dict.index);\n\t\t\tconst [tm2, ty2, us2] = yield EB.infer(dict.term);\n\t\t\tconst ctx = yield* V2.ask();\n\t\t\tconst m = yield* EB.freshMeta(ctx.env.length, NF.Type);\n\t\t\tconst strategy = match(tm1)\n\t\t\t\t// We check free variables for primitive types because elaboration tries to preserve variable names. This helps with displaying, debugging, and error messages.\n\t\t\t\t// TODO: Maybe add some Primitive wrappers to hide the free variable nature of these terms?\n\t\t\t\t.with({ type: \"Lit\", value: { type: \"Atom\", value: \"String\" } }, { type: \"Var\", variable: { type: \"Free\", name: \"String\" } }, () =>\n\t\t\t\t\tEB.Constructors.Var({ type: \"Foreign\", name: \"defaultHashMap\" }),\n\t\t\t\t)\n\t\t\t\t.with({ type: \"Lit\", value: { type: \"Atom\", value: \"Num\" } }, { type: \"Var\", variable: { type: \"Free\", name: \"Num\" } }, () =>\n\t\t\t\t\tEB.Constructors.Var({ type: \"Foreign\", name: \"defaultArray\" }),\n\t\t\t\t)\n\t\t\t\t.otherwise(() => EB.Constructors.Var(m));\n\t\t\treturn [EB.Constructors.Indexed(tm1, tm2, strategy), NF.Type, Q.add(us1, us2)] satisfies EB.AST;\n\t\t}),\n\t);\n\ninfer.gen = F.flow(infer, V2.pure);\n"],"mappings":";AAAA,YAAY,OAAO;AAEnB,YAAY,QAAQ;AACpB,YAAY,QAAQ;AAEpB,YAAY,QAAQ;AAGpB,YAAY,OAAO;AACnB,SAAS,aAAa;AAIf,MAAM,QAAQ,CAAC,SACrB,GAAG;AAAA,EACF,EAAE,KAAK,OAAO,MAAM,QAAQ,MAAM,MAAM,UAAU,EAAE,QAAQ,SAAS,aAAa,aAAa,EAAE;AAAA,EACjG,GAAG,GAAmB,aAAa;AAClC,UAAM,CAAC,KAAK,KAAK,GAAG,IAAI,MAAM,GAAG,MAAM,KAAK,KAAK;AACjD,UAAM,CAAC,KAAK,KAAK,GAAG,IAAI,MAAM,GAAG,MAAM,KAAK,IAAI;AAChD,UAAM,MAAM,OAAO,GAAG,IAAI;AAC1B,UAAM,IAAI,OAAO,GAAG,UAAU,IAAI,IAAI,QAAQ,GAAG,IAAI;AACrD,UAAM,WAAW,MAAM,GAAG,EAGxB;AAAA,MAAK,EAAE,MAAM,OAAO,OAAO,EAAE,MAAM,QAAQ,OAAO,SAAS,EAAE;AAAA,MAAG,EAAE,MAAM,OAAO,UAAU,EAAE,MAAM,QAAQ,MAAM,SAAS,EAAE;AAAA,MAAG,MAC7H,GAAG,aAAa,IAAI,EAAE,MAAM,WAAW,MAAM,iBAAiB,CAAC;AAAA,IAChE,EACC;AAAA,MAAK,EAAE,MAAM,OAAO,OAAO,EAAE,MAAM,QAAQ,OAAO,MAAM,EAAE;AAAA,MAAG,EAAE,MAAM,OAAO,UAAU,EAAE,MAAM,QAAQ,MAAM,MAAM,EAAE;AAAA,MAAG,MACvH,GAAG,aAAa,IAAI,EAAE,MAAM,WAAW,MAAM,eAAe,CAAC;AAAA,IAC9D,EACC,UAAU,MAAM,GAAG,aAAa,IAAI,CAAC,CAAC;AACxC,WAAO,CAAC,GAAG,aAAa,QAAQ,KAAK,KAAK,QAAQ,GAAG,GAAG,MAAM,EAAE,IAAI,KAAK,GAAG,CAAC;AAAA,EAC9E,CAAC;AACF;AAED,MAAM,MAAM,EAAE,KAAK,OAAO,GAAG,IAAI;","names":[]}