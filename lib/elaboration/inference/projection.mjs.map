{"version":3,"sources":["../../../src/elaboration/inference/projection.ts"],"sourcesContent":["import * as EB from \"@yap/elaboration\";\nimport * as V2 from \"@yap/elaboration/shared/monad.v2\";\nimport * as Q from \"@yap/shared/modalities/multiplicity\";\n\nimport * as Src from \"@yap/src/index\";\nimport * as NF from \"@yap/elaboration/normalization\";\nimport { match } from \"ts-pattern\";\n\nimport * as Lit from \"@yap/shared/literals\";\nimport * as F from \"fp-ts/function\";\n\ntype Projection = Extract<Src.Term, { type: \"projection\" }>;\n\nexport const infer = V2.regen(\n\t({ label, term }: Projection): V2.Elaboration<EB.AST> =>\n\t\tV2.track(\n\t\t\t{ tag: \"src\", type: \"term\", term, metadata: { action: \"infer\", description: \"Projection of label: \" + label } },\n\t\t\tV2.Do<EB.AST, EB.AST>(function* () {\n\t\t\t\tconst [tm, ty, us] = yield* EB.infer.gen(term);\n\t\t\t\tconst inferred = yield* project.gen(label, tm, ty, us);\n\t\t\t\treturn [EB.Constructors.Proj(label, tm), inferred, us] satisfies EB.AST; // TODO: Subtract usages?\n\t\t\t}),\n\t\t),\n);\n\nexport const project = (label: string, tm: EB.Term, ty: NF.Value, us: Q.Usages): V2.Elaboration<NF.Value> =>\n\tV2.Do(function* () {\n\t\tconst ctx = yield* V2.ask();\n\t\tconst nf = match(ty)\n\t\t\t.with({ type: \"Neutral\" }, ({ value }) => project(label, tm, value, us))\n\t\t\t.with({ type: \"Var\" }, _ =>\n\t\t\t\tV2.Do(function* () {\n\t\t\t\t\tconst rowTypeCtor = EB.Constructors.Pi(\"rx\", \"Explicit\", EB.Constructors.Lit(Lit.Row()), EB.Constructors.Lit(Lit.Type()));\n\t\t\t\t\tconst ann = NF.evaluate(ctx, rowTypeCtor);\n\t\t\t\t\tconst ctor = NF.evaluate(ctx, EB.Constructors.Var(yield* EB.freshMeta(ctx.env.length, ann)));\n\n\t\t\t\t\tconst kind = NF.Constructors.Var(yield* EB.freshMeta(ctx.env.length, NF.Type));\n\t\t\t\t\tconst val = NF.evaluate(ctx, EB.Constructors.Var(yield* EB.freshMeta(ctx.env.length, kind)));\n\n\t\t\t\t\tconst r: NF.Row = { type: \"variable\", variable: yield* EB.freshMeta(ctx.env.length, NF.Row) };\n\t\t\t\t\tconst xtension = NF.Constructors.Extension(label, val, r);\n\t\t\t\t\tconst inferred = NF.Constructors.App(ctor, NF.Constructors.Row(xtension), \"Explicit\");\n\n\t\t\t\t\tyield* V2.tell(\"constraint\", { type: \"assign\", left: inferred, right: ty });\n\n\t\t\t\t\treturn inferred;\n\t\t\t\t}),\n\t\t\t)\n\t\t\t.with(NF.Patterns.Schema, ({ func, arg }) =>\n\t\t\t\tV2.Do(function* () {\n\t\t\t\t\tconst from = (l: string, row: NF.Row): V2.Elaboration<[NF.Row, NF.Value]> => {\n\t\t\t\t\t\treturn match(row)\n\t\t\t\t\t\t\t.with({ type: \"empty\" }, _ => {\n\t\t\t\t\t\t\t\treturn V2.Do(() => V2.fail<[NF.Row, NF.Value]>({ type: \"MissingLabel\", label: l, row }));\n\t\t\t\t\t\t\t\t//throw new Error(\"Label not found: \" + l);\n\t\t\t\t\t\t\t})\n\t\t\t\t\t\t\t.with(\n\t\t\t\t\t\t\t\t{ type: \"extension\" },\n\t\t\t\t\t\t\t\t({ label: l_ }) => l === l_,\n\t\t\t\t\t\t\t\t({ label, value, row }) => V2.of<[NF.Row, NF.Value]>([NF.Constructors.Extension(label, value, row), value]),\n\t\t\t\t\t\t\t)\n\t\t\t\t\t\t\t.with({ type: \"extension\" }, r =>\n\t\t\t\t\t\t\t\tV2.Do(function* () {\n\t\t\t\t\t\t\t\t\tconst [rr, vv]: [NF.Row, NF.Value] = yield from(l, r.row);\n\t\t\t\t\t\t\t\t\treturn [NF.Constructors.Extension(r.label, r.value, rr), vv] satisfies [NF.Row, NF.Value];\n\t\t\t\t\t\t\t\t}),\n\t\t\t\t\t\t\t)\n\t\t\t\t\t\t\t.with({ type: \"variable\" }, r =>\n\t\t\t\t\t\t\t\tV2.Do(function* () {\n\t\t\t\t\t\t\t\t\tconst kind = NF.Constructors.Var(yield* EB.freshMeta(ctx.env.length, NF.Type));\n\t\t\t\t\t\t\t\t\tconst val = NF.evaluate(ctx, EB.Constructors.Var(yield* EB.freshMeta(ctx.env.length, kind)));\n\t\t\t\t\t\t\t\t\treturn [NF.Constructors.Extension(l, val, r), val] satisfies [NF.Row, NF.Value];\n\t\t\t\t\t\t\t\t}),\n\t\t\t\t\t\t\t)\n\t\t\t\t\t\t\t.exhaustive();\n\t\t\t\t\t};\n\n\t\t\t\t\tconst [r, v]: [NF.Row, NF.Value] = yield from(label, arg.row);\n\t\t\t\t\tconst inferred = NF.Constructors.App(func, NF.Constructors.Row(r), \"Explicit\");\n\t\t\t\t\tyield* V2.tell(\"constraint\", { type: \"assign\", left: inferred, right: ty });\n\t\t\t\t\treturn v;\n\t\t\t\t}),\n\t\t\t)\n\t\t\t.otherwise(_ => {\n\t\t\t\tthrow new Error(\"Expected Row Type\");\n\t\t\t});\n\n\t\treturn yield* V2.pure(nf);\n\t});\n\nproject.gen = F.flow(project, V2.pure);\n"],"mappings":"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","names":["label","row","r"]}