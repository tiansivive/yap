{"version":3,"sources":["../src/interpreter.ts"],"sourcesContent":["import Nearley from \"nearley\";\nimport Grammar from \"@yap/src/grammar\";\n\nimport * as Src from \"@yap/src/index\";\nimport * as EB from \"@yap/elaboration\";\n\nimport * as E from \"fp-ts/lib/Either\";\n\nimport * as CG from \"./Codegen/terms\";\n\nimport fs from \"fs\";\nimport vm from \"vm\";\nimport util from \"util\";\nimport { format, resolve } from \"path\";\n\nimport * as Lib from \"@yap/shared/lib/primitives\";\n\nimport beautify from \"js-beautify\";\n\nexport const interpret = (code: string, ctx: EB.Context, opts = { nf: false }) => {\n\tconst g = Grammar;\n\tg.ParserStart = \"Script\";\n\tconst parser = new Nearley.Parser(Nearley.Grammar.fromCompiled(Grammar));\n\n\tconst sanitized = code.trim().endsWith(\";\") ? code : `${code};`;\n\tconst data = parser.feed(sanitized);\n\tif (data.results.length !== 1) {\n\t\tconsole.error(\"Failed to parse statement\");\n\n\t\tfs.writeFileSync(resolve(process.cwd(), \"./.logs/error.json\"), JSON.stringify(data.results, null, 2));\n\n\t\tthrow new Error(\"Error while parsing statement. Check error.json for more information\");\n\t}\n\n\tconst { script }: Src.Script = data.results[0];\n\tif (script.length !== 1) {\n\t\tthrow new Error(\"Expected a single statement\");\n\t}\n\tconst [stmt] = script;\n\n\treturn interpretStmt(stmt, ctx, opts);\n};\n\nconst letdecs: string[] = [];\nconst interpretStmt = (stmt: Src.Statement, ctx: EB.Context, opts = { nf: false }) => {\n\tif (stmt.type === \"let\") {\n\t\tconst [name, result] = EB.Mod.letdec(stmt, ctx);\n\n\t\tif (E.isLeft(result)) {\n\t\t\tconsole.warn(EB.V2.display(result.left));\n\t\t\t//console.error(`Error interpreting ${name}: ${result.left}`);\n\t\t\treturn ctx;\n\t\t}\n\n\t\tconst [[tm, ty, us], ctx_] = result.right;\n\n\t\tconst code = `let ${name} = ${CG.codegen([name], tm)};`;\n\t\tletdecs.push(code);\n\t\tconsole.log(`:: ${EB.NF.display(ty, ctx)}`);\n\n\t\tif (opts.nf) {\n\t\t\tconst nf = EB.NF.evaluate(ctx, tm);\n\t\t\tconsole.log(`NF: ${EB.NF.display(nf, ctx)}`);\n\t\t}\n\n\t\tconsole.log(`\\n\\n${code}`);\n\n\t\treturn ctx_;\n\t}\n\n\tif (stmt.type === \"expression\") {\n\t\tconst result = EB.Mod.expression(stmt, ctx);\n\n\t\tif (E.isLeft(result)) {\n\t\t\tconsole.warn(EB.V2.display(result.left));\n\t\t\t//console.error(`Error interpreting expression: ${result.left}`);\n\t\t\treturn ctx;\n\t\t}\n\n\t\tconst [tm, ty, us, zonker] = result.right;\n\t\tconst code = CG.codegen([], tm);\n\n\t\tconst script = letdecs.join(\"\\n\") + `\\n${code}`;\n\n\t\tconst formatted = beautify.js(script, { indent_size: 2 });\n\t\t//prettier.format(script, { parser: \"babel\", semi: true })\n\t\tconsole.log(\"\\nTranspiled JavaScript:\\n\");\n\t\tconsole.log(formatted);\n\n\t\tconst imported = Object.keys(ctx.imports).reduce((acc, key) => {\n\t\t\treturn { ...acc, [key]: key };\n\t\t}, {});\n\t\tconst vmCtx = vm.createContext({ ...imported, ...Lib.FFI });\n\t\tconst res = vm.runInContext(script, vmCtx);\n\n\t\t//console.dir(res, { showHidden: true, depth: null });\n\t\t// console.dir(Object.getOwnPropertyDescriptors(res), { showHidden: true, depth: null });\n\t\tconst pretty = typeof res === \"function\" ? beautify.js(res.toString(), { indent_size: 2 }) : util.inspect(res, { showHidden: true, depth: null });\n\t\tconsole.log(\"\\n\" + pretty + ` :: ${EB.NF.display(ty, { zonker, metas: ctx.metas, env: ctx.env })}\\n`);\n\n\t\tif (opts.nf) {\n\t\t\tconst nf = EB.NF.evaluate(ctx, tm);\n\t\t\tconsole.log(`NF: ${EB.NF.display(nf, { zonker, metas: ctx.metas, env: ctx.env })}`);\n\t\t}\n\t\treturn ctx;\n\t}\n\n\tthrow new Error(\"Unsupported statement\");\n};\n"],"mappings":"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","names":[]}