{"version":3,"sources":["../../src/shared/rows.ts"],"sourcesContent":["import { match, P } from \"ts-pattern\";\n\nimport * as E from \"fp-ts/lib/Either\";\n\nexport type Injection<T> = { type: \"injection\"; label: string; value: T; term: T };\nexport type Projection<T> = { type: \"projection\"; label: string; term: T };\n\nexport type Row<T, V> = { type: \"empty\" } | { type: \"extension\"; label: string; value: T; row: Row<T, V> } | { type: \"variable\"; variable: V };\nexport type Extension<T, V> = Extract<Row<T, V>, { type: \"extension\" }>;\n\nexport const Constructors = {\n\tExtension: <T, V>(label: string, value: T, row: Row<T, V>): Extension<T, V> => ({ type: \"extension\", label, value, row }),\n\tVariable: <T, V>(variable: V): Row<T, V> => ({ type: \"variable\", variable }),\n\tEmpty: <T, V>(): Row<T, V> => ({ type: \"empty\" }),\n};\n\nexport const display =\n\t<T, V>(pretty: { term: (term: T) => string; var: (variable: V) => string }) =>\n\t(row: Row<T, V>): string => {\n\t\tif (row.type === \"empty\") {\n\t\t\treturn \"[]\";\n\t\t}\n\n\t\tconst recurse = (r: Row<T, V>): string =>\n\t\t\tmatch(r)\n\t\t\t\t.with({ type: \"empty\" }, () => \"\")\n\t\t\t\t.with({ type: \"extension\" }, ({ label, value, row }) => {\n\t\t\t\t\tconst v = pretty.term(value);\n\n\t\t\t\t\tif (row.type === \"empty\") {\n\t\t\t\t\t\treturn `${label}: ${v}`;\n\t\t\t\t\t}\n\n\t\t\t\t\tif (row.type === \"variable\") {\n\t\t\t\t\t\treturn `${label}: ${v} ${recurse(row)}`;\n\t\t\t\t\t}\n\n\t\t\t\t\treturn `${label}: ${v}, ${recurse(row)}`;\n\t\t\t\t})\n\t\t\t\t.with({ type: \"variable\" }, ({ variable }) => `| ${pretty.var(variable)}`)\n\t\t\t\t.run();\n\n\t\treturn `[ ${recurse(row)} ]`;\n\t};\n\nexport const traverse = <T, V, A, B>(row: Row<T, V>, onVal: (value: T, label: string) => A, onVar: (v: V) => Row<A, B>): Row<A, B> =>\n\tmatch(row)\n\t\t.with({ type: \"empty\" }, (r): Row<A, B> => r)\n\t\t.with({ type: \"extension\" }, ({ label, value, row }) => Constructors.Extension(label, onVal(value, label), traverse(row, onVal, onVar)))\n\t\t.with({ type: \"variable\" }, ({ variable }) => onVar(variable))\n\t\t.exhaustive();\n\nexport const fold = <T, V, A>(row: Row<T, V>, onVal: (value: T, label: string, acc: A) => A, onVar: (v: V, acc: A) => A, acc: A): A => {\n\tconst recurse = (r: Row<T, V>, acc: A): A =>\n\t\tmatch(r)\n\t\t\t.with({ type: \"empty\" }, () => acc)\n\t\t\t.with({ type: \"extension\" }, ({ label, value, row }) => recurse(row, onVal(value, label, acc)))\n\t\t\t.with({ type: \"variable\" }, ({ variable }) => onVar(variable, acc))\n\t\t\t.run();\n\n\treturn recurse(row, acc);\n};\n\n// FIXME:TODO: Improve Error handling. Most likely need to parameterize `rewrite` over the error type.\ntype Err = { tag: \"Mismatch\"; label: string } | { tag: \"ExpectedExtension\" } | { tag: \"Other\"; message: string };\n\nexport const rewrite = <T, V>(r: Row<T, V>, label: string, onVar?: (v: V) => E.Either<Err, [T, V]>): E.Either<Err, Row<T, V>> => {\n\treturn match(r)\n\t\t.with({ type: \"empty\" }, () => E.left({ tag: \"Mismatch\", label } satisfies Err))\n\t\t.with(\n\t\t\t{ type: \"extension\" },\n\t\t\t({ label: l }) => label === l,\n\t\t\t({ label: l, value, row }) => E.right(Constructors.Extension(l, value, row)),\n\t\t)\n\t\t.with({ type: \"extension\" }, ({ label: lbl, value: val, row }) =>\n\t\t\tE.Monad.chain(rewrite(row, label, onVar), res =>\n\t\t\t\tmatch(res)\n\t\t\t\t\t.with({ type: \"extension\" }, ({ label: l, value: v, row: r }) => E.right(Constructors.Extension(l, v, Constructors.Extension(lbl, val, r))))\n\t\t\t\t\t.otherwise(() => E.left({ tag: \"ExpectedExtension\" } satisfies Err)),\n\t\t\t),\n\t\t)\n\t\t.with({ type: \"variable\" }, r => {\n\t\t\tif (!onVar) {\n\t\t\t\treturn E.right(r);\n\t\t\t}\n\t\t\treturn E.Functor.map(onVar(r.variable), ([val, v]) => {\n\t\t\t\tconst rvar = Constructors.Variable<T, V>(v);\n\t\t\t\tconst rf = Constructors.Extension<T, V>(label, val, rvar);\n\t\t\t\treturn rf;\n\t\t\t});\n\t\t})\n\t\t.exhaustive();\n};\n"],"mappings":"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","names":["row","acc","r"]}